---
title: "Getting Started with TernTables"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started with TernTables}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse  = TRUE,
  comment   = "#>",
  warning   = FALSE,
  message   = FALSE
)
library(TernTables)
options(tibble.width = Inf)  # show all columns in printed tibbles
# Output directory for exported .docx files.
# Override by setting options(TernTables.vignette_outdir = "/your/path") before rendering.
out_dir <- getOption("TernTables.vignette_outdir", default = tempdir())
```

```{css, echo = FALSE}
img { border: none !important; box-shadow: none !important; }
```

## Overview

**TernTables** is built for clinical researchers who need to go from raw data to a manuscript-ready Word table — with variable detection, statistical test selection, and formatting all handled automatically.

Given a data frame and an optional grouping variable, it automatically:

- Detects each variable's type (continuous, binary, categorical)
- Selects the appropriate statistical test
- Formats *P* values and summary statistics for publication-ready tables
- Exports directly to a styled `.docx` Word file and generates a boilerplate
  statistical methods paragraph
- Returns a tibble for inspection, Excel export, or further analysis in R

Three table types are supported: **descriptive summaries** (single cohort, no
comparisons), **two-group comparisons** (with optional odds ratios), and
**comparisons across three or more groups**.

The convenience is in the automation, not in any compromise to statistical
rigor. Test selection follows established published criteria throughout:
normality by Shapiro-Wilk per group, Fisher's exact triggered by the Cochran
(1954) expected-cell criterion, and odds ratios reported as unadjusted with
the first factor level of the grouping variable as the reference. The auto-generated methods paragraph covers the statistical approach used and is suitable as a starting draft for a manuscript methods section.

## Example Dataset

```{r load-data}
data(tern_colon)
```

`tern_colon` is bundled with TernTables. It is derived from `survival::colon`
and contains 929 patients from a landmark colon cancer adjuvant chemotherapy
trial (Moertel et al., 1990), filtered to the recurrence endpoint — one row
per patient. See `?tern_colon` for full details.

Key variables used in these examples:

| Column | Description |
|---|---|
| `Age_Years` | Age at registration (years) |
| `Sex` | Female / Male |
| `Colonic_Obstruction` | Colonic obstruction present — n (%) |
| `Bowel_Perforation` | Bowel perforation present — n (%) |
| `Positive_Lymph_Nodes_n` | Number of positive lymph nodes |
| `Over_4_Positive_Nodes` | More than 4 positive lymph nodes — n (%) |
| `Tumor_Adherence` | Tumour adherence to nearby organs — n (%) |
| `Tumor_Differentiation` | Well / Moderate / Poor |
| `Extent_of_Local_Spread` | Depth of tumour penetration (4 levels) |
| `Recurrence` | No Recurrence / Recurrence — **2-group** |
| `Treatment_Arm` | Levamisole + 5FU / Levamisole / Observation — **3-group** |

---

## Descriptive Table (`ternD`)

Use `ternD()` for a single cohort with no group comparisons — the standard
"Table 1" in a cohort description. Pass `output_docx` to write a
publication-ready Word file in the same call; pass `output_xlsx` to also save
the tibble as an Excel file. Use `category_start` to insert bold section headers
grouping related variables; anchors can be either the raw column name or the
cleaned display label.

```{r ternD-example, results = "hide"}
tbl_descriptive <- ternD(
  data             = tern_colon,
  exclude_vars     = c("ID"),
  output_docx      = file.path(out_dir, "Tern_descriptive.docx"),
  methods_filename = file.path(out_dir, "TernTables_methods.docx"),
  category_start = c(
    "Patient Demographics"  = "Age (yr)",
    "Surgical Findings"     = "Colonic Obstruction",
    "Tumor Characteristics" = "Positive Lymph Nodes (n)",
    "Outcomes"              = "Recurrence"
  )
)
tbl_descriptive
```

Continuous variables show mean ± SD or median [IQR] depending on normality
(Shapiro-Wilk, p > 0.05 = normal). Columns whose values are exactly Y/N,
YES/NO, or numeric 0/1 are detected as binary and shown as a single n (%) row
(the positive/yes count). All other categorical variables — including two-level
variables like Male/Female — are shown with each level as an indented sub-row.

Variable names are automatically cleaned for display (`smart_rename = TRUE` by
default) — underscores replaced with spaces, capitalisation normalised, and
common medical abbreviations formatted (e.g. `Age_Years` → `Age (yr)`,
`Positive_Lymph_Nodes_n` → `Positive Lymph Nodes (n)`). Pass
`smart_rename = FALSE` to use column names exactly as they appear in the data.

Descriptive summary table exported to Word:

```{r ternD-figure, echo=FALSE, fig.align="center", out.width="45%"}
knitr::include_graphics("figures/tern_descriptive.png")
```

---

## Two-Group Comparison (`ternG` — 2 levels)

Use `ternG()` to compare variables between two groups. Set `OR_col = TRUE` to
add odds ratios with 95% CI for binary variables (Fisher's exact or Wald,
chosen automatically based on expected cell counts). Pass `output_docx` to
write the Word table directly; `output_xlsx` exports the tibble to Excel.

```{r ternG-2group, results = "hide"}
tbl_2group <- ternG(
  data             = tern_colon,
  exclude_vars     = c("ID"),
  group_var        = "Recurrence",
  output_docx      = file.path(out_dir, "Tern_2_group.docx"),
  methods_filename = file.path(out_dir, "TernTables_methods.docx"),
  OR_col           = TRUE,
  insert_subheads  = TRUE,
  category_start   = c(
    "Patient Demographics"  = "Age (yr)",
    "Surgical Findings"     = "Colonic Obstruction",
    "Tumor Characteristics" = "Positive Lymph Nodes (n)",
    "Treatment Details"     = "Treatment Arm"
  )
)
tbl_2group
```

The Word table includes an OR column (odds ratio with 95% CI for binary
variables) and a *P* value column (test *P* value for each variable).

Two-group comparison table exported to Word, with odds ratios and category section headers:

![](figures/tern_2_group.png){width=100%}

---

## Three or More Groups (`ternG` — 3+ levels)

The same `ternG()` function handles three or more groups automatically,
switching from t-test/Wilcoxon to ANOVA/Kruskal-Wallis as appropriate.
Odds ratios are not available for 3+ group comparisons. `consider_normality`
controls whether Shapiro-Wilk is used to choose between parametric and
nonparametric tests; the default (`TRUE`) enables this, `FALSE` forces
parametric tests throughout, and `"FORCE"` forces nonparametric throughout.

```{r ternG-3group, results = "hide"}
tbl_3group <- ternG(
  data               = tern_colon,
  exclude_vars       = c("ID"),
  group_var          = "Treatment_Arm",
  group_order        = c("Observation", "Levamisole", "Levamisole + 5FU"),
  output_docx        = file.path(out_dir, "Tern_3_group.docx"),
  methods_filename   = file.path(out_dir, "TernTables_methods.docx"),
  consider_normality = TRUE,
  category_start     = c(
    "Patient Demographics"  = "Age (yr)",
    "Surgical Findings"     = "Colonic Obstruction",
    "Tumor Characteristics" = "Positive Lymph Nodes (n)",
    "Outcomes"              = "Recurrence"
  )
)
tbl_3group
```

Three-group comparison table exported to Word with category section headers:

![](figures/tern_3_group.png){width=100%}

---

## Statistical Test Logic

TernTables selects tests automatically based on variable type and normality:

| Variable type | Test (2 groups) | Test (3+ groups) |
|---|---|---|
| Continuous, normal | Welch's *t*-test | ANOVA |
| Continuous, non-normal | Wilcoxon rank-sum | Kruskal-Wallis |
| Binary / Categorical | Fisher's exact or Chi-squared\* | Fisher's exact or Chi-squared\* |
| Ordinal (`force_ordinal`) | Wilcoxon rank-sum | Kruskal-Wallis |

\*Fisher's exact is used when any expected cell count is < 5 (Cochran criterion).

Normality is assessed with the Shapiro-Wilk test (p > 0.05 = normal) applied
per group; a variable is treated as normally distributed only if all groups
pass. If any group fails — or if a group has fewer than 3 observations and
normality cannot be evaluated — the nonparametric test is used (conservative
fail-safe). For 3+ group comparisons, omnibus *P* values are reported; pairwise
post-hoc comparisons are not performed.

---

## Methods Document

A methods paragraph is written automatically with every `ternD()` and `ternG()`
call (`methods_doc = TRUE` by default), saved to `"TernTables_methods.docx"` in
the working directory unless overridden via `methods_filename`. Set
`methods_doc = FALSE` to suppress it.

`write_methods_doc()` can also be called directly on any saved tibble. Pass
`show_test = TRUE` to `ternG()` to populate the `test` column; when present,
the paragraph is tailored to only the test types that actually appeared (e.g.
omits the t-test sentence if all continuous variables were nonparametric).
Without it, standard boilerplate is used.

```{r methods-doc, eval = FALSE}
write_methods_doc(
  tbl      = tbl_2group,
  filename = file.path(out_dir, "Tern_methods.docx")
)
```

---

## References

Moertel CG, Fleming TR, Macdonald JS, et al. (1990). Levamisole and fluorouracil
for adjuvant therapy of resected colon carcinoma. *New England Journal of Medicine*,
**322**(6), 352–358. <https://doi.org/10.1056/NEJM199002083220602>
